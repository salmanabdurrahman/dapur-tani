name: Deploy Laravel to cPanel via Git Pull
description: This workflow deploys the Laravel application to cPanel by pulling the latest changes from the main branch using SSH and Composer, NPM, and Artisan commands.

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to cPanel
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          cd /home/salmanab/dapurtani.salmanabdurrahman.my.id
          
          echo "Setting up Deploy Key for Git Pull..."
          eval $(ssh-agent -s)
          echo "${{ secrets.DEPLOY_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem
          ssh-add deploy_key.pem
          rm deploy_key.pem
          
          echo "Pulling latest changes from main branch..."
          git pull origin main
          
          echo "Installing Composer dependencies..."
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
          
          echo "Installing NPM dependencies and building assets..."
          npm install
          
          echo "Running database migrations..."
          php artisan migrate --force
          
          echo "Optimizing application..."
          php artisan filament:optimize
          php artisan filament:optimize-clear
          php artisan optimize:clear
          php artisan optimize
          
          echo "Deployment successful!"